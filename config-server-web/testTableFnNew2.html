<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="layui/css/layui.css" media="all">
    <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
</head>
<body>

<button class="layui-btn" id="createNew">新增一条数据</button>
<button class="layui-btn" id="getAllData">获得表格所有数据</button>
<div id="testTable" lay-filter="testTable"></div>

<script type="text/html" id="table_tool">
    <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</a>
</script>

<script type="text/html" id="tableForm">
    <form class="layui-form" lay-filter="myForm"> <!-- 提示：如果你不想用form，你可以换成div等任何一个普通元素 -->
        <div class="layui-form-item">
            <label class="layui-form-label">姓名</label>
            <div class="layui-input-block">
                <input type="text" name="name" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">年龄</label>
            <div class="layui-input-block">
                <input type="text" name="age" placeholder="请输入" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item" hidden>
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="myFormSubmit">立即提交</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</script>

<script src="layui/layui.js" charset="utf-8"></script>
<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->

<script>
    layui.use(['jquery', 'laydate', 'util', 'layer', 'table', 'form'], function ($, laydate, util, layer, table, form) {
        var tableIns = table.render({
            elem: '#testTable',
            height: 480,
            data: [
                {
                    id: 1,
                    name: '小王',
                    age: 12,
                    sex: 'M',
                    like: 'read,travel,games',
                    birthDate: '2018-06-01',
                    addr: '广东',
                    msg: '这个人很懒什么也没有留下'
                },
                {id: 2, name: '小李', age: 13, sex: 'F', vip: true, like: 'read,games', addr: '北京', msg: '楼上最帅'},
                {id: 3, name: '小赵', age: 22, sex: 'F', like: 'read', addr: '河北', msg: '这个人很懒什么也没有留下'},
                {id: 4, name: '大王', age: 18, sex: 'M', like: 'travel,games', addr: '山东'}
            ],
            page: {},
            cols: [[
                {type: 'checkbox', fixed: true},
                {field: 'id', title: 'ID', edit: true, fixed: true},
                {field: 'name', edit: true, title: '名称'},
                {field: 'age', title: '年龄', templet: '<div>{{# if(d.age) {}} {{d.age}} {{# } else {}} <button class="layui-btn layui-btn-xs" style="float: right;" lay-event="modify">...</button> {{# } }}</div>'},
                {
                    field: 'sex', title: '性别', templet: function (d) {
                        return '<span>' + (d.sex === 'M' ? '男' : '女') + '</span>';
                    }
                },
                {toolbar: '#table_tool', title: '操作', fixed: 'right', align: 'center', width: 120}
            ]],
        });

        // 工具监听
        table.on('tool(testTable)', function (obj) {
            switch (obj.event) {
                case 'del':
                    // data.del();
                    // layer.confirm('玩玩而已不用担心一会还会回来的。', function(index){
                    //     obj.del();
                    //     layer.close(index);
                    // });
                    // 只做测试数据的删除用，url的删除一般都是发交易然后重载表格就可以了
                    var tableObj = tableIns;
                    var config = tableObj.config;
                    var dataTemp = config.data;
                    var page = config.page;
                    // 得到tr的data-index
                    var trElem = obj.tr.first();
                    var index = trElem.data('index');
                    // 计算出在data中的index
                    var dataIndex = index + page.limit * (page.curr - 1);
                    // 删除对应下标的数据
                    dataTemp.splice(dataIndex, 1);

                    // 新的页数
                    var pageNew = Math.ceil(dataTemp.length / page.limit);

                    // 重新接收reload返回的对象，这个很重要
                    tableIns = table.reload(config.id, $.extend(true, {
                        // 更新数据
                        data: dataTemp
                    }, config.page ? {
                        // 如果删除了数据之后页数变了，打开前一页
                        page: {
                            curr: page.curr > pageNew ? ((page.curr - 1) || 1) : page.curr
                        }
                    } : {}));
                    break;
                case 'modify':
                    //
                    layer.open({
                        type: 1,
                        area: ['60%', '40%'],
                        content: '<div style="padding: 10px;">'+$('#tableForm').html()+'</div>',
                        btn: ['确定', '重置', '取消'],
                        yes: function(index, layero) {
                            layero.find('form button[lay-submit]').click();
                            layer.close(index);
                        },
                        btn2: function(index, layero) {
                            layero.find('form button[type="reset"]').click();
                            return false;
                        },
                        success: function () {
                            form.on('submit(myFormSubmit)', function (data) {
                                obj.update(data.field);
                                return false;
                            });
                        }
                    });
                    break;
                default:
                    break;
            }
        });

        // 新增一条记录
        $('#createNew').click(function () {
            var tableObj = tableIns;
            var config = tableObj.config;
            var dataTemp = config.data;
            dataTemp.push({id: 'new' + new Date().getTime()});
            tableIns = table.reload(config.id, $.extend(true, {
                // 更新数据
                data: dataTemp,
            }, config.page ? {
                // 一般新增都是加到最后，所以始终打开最后一页
                page: {
                    curr: Math.ceil(dataTemp.length / config.page.limit)
                }
            } : {}));
        });

        // 获得表格的所有数据
        $('#getAllData').click(function () {
            layer.alert(JSON.stringify(tableIns.config.data));
        });
    });
</script>
</body>
</html>